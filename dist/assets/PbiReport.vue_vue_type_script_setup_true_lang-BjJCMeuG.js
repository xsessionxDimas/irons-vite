import{A as $}from"./PbiEmbeddedEnums-BaTTPSF0.js";import{p as b}from"./powerbi-client-BGzjSA60.js";import{u as W}from"./vuex-BbOKrtVp.js";import{d as G}from"./date-format-BASVuupi.js";import{o as H}from"./vue-router-iNp9kJ0K.js";import{u as K,c as M}from"./index-BCnwA6yE.js";import{g as Y,a as z,c as Q}from"./utils-CryoXyYA.js";import{k as X,r as T,c as V,o as Z,y as ee,p as te,aa as ie,Y as oe}from"./@vue-BypzYtbH.js";const ae=5,se=3e5,ge=X({__name:"PbiReport",props:["reportName","visibletab","idPageName","isPublic","pbiReportId","pbiWorkspaceId","isHideVisualHeaders","isTransparent"],emits:["handle-click"],setup(E,{emit:re}){const w=K(),f=E,k=W(),o=Q,N=T();let s;const P=T(0),v=T(""),C=T(!1),x=V(()=>k.getters.getIsDashboardConfigLoading),S=V(()=>k.getters.getDashboardConfigPbi),L=()=>{const a={type:"report",tokenType:b.models.TokenType.Embed||"",accessToken:S.value.embedToken.token||"",embedUrl:S.value.embedReport[0].embedUrl||"",id:S.value.embedReport[0].reportId||"",permissions:b.models.Permissions.All,settings:{panes:{filters:{visible:!1},pageNavigation:{visible:typeof f.visibletab>"u"?!0:f.visibletab}}}};return f.isTransparent&&(a.settings.background=b.models.BackgroundType.Transparent),a},F=()=>{try{if(typeof S.value<"u"){const a=L();let t=new b.service.Service(b.factories.hpmFactory,b.factories.wpmpFactory,b.factories.routerFactory);N.value&&(s=t.embed(N.value,a)),s.off("loaded"),s.on("loaded",async()=>{const i=await s.getPages(),p=await i.find(e=>e.displayName==="Buma Level").getVisuals();s.off("dataSelected"),s.on("dataSelected",async e=>{if(e.detail.visual.type=="slicer")try{C.value=!0;let r=(await(await s.getActivePage()).getVisuals()).filter(l=>l.type==="slicer"&&l.title===e.detail.visual.title)[0];const n=await r.getSlicerState();if(n){let l=[],u="",d=[];if(n.filters.length>0&&(d=[...n.filters[0].values],u=n.filters[0].operator),d.length==0||n.filters[0].operator=="NotIn"){let O=await r.exportData();l=Y(O?O.data:"")}y(e.detail.visual.title,u,d,l)}}catch(c){console.log(c)}finally{C.value=!1}e.detail.visual.title=="Table_Detail"&&j(e.detail.dataPoints[0].identity)}),s.off("buttonClicked"),s.on("buttonClicked",async e=>{if(!e.detail.title.includes("clear")&&!e.detail.title.includes("clr"))return;const c=o.findIndex(r=>r.btnClearTitles.includes(e.detail.title));if(c==-1)return;for(let r=c;r<o.length;r++){const n=o[r];y(n.slicerTitle,"",[],[])}if(o[0].btnClearTitles.findIndex(r=>e.detail.title.includes(r))!=-1){const r=v.value==""?[]:{filters:[{$schema:"http://powerbi.com/product/schema#basic",operator:"In",values:[v.value],target:{table:o[0].table,column:o[0].column},filterType:1,requireSingleSelection:!0}]};try{await(await i.find(d=>d.isActive).getVisuals()).filter(d=>d.type==="slicer"&&d.title===o[0].slicerTitle)[0].setSlicerState(r),console.log("success set site again"),y(o[0].slicerTitle,"In",v.value==""?[]:[],[])}catch(n){console.log(n)}}});const g=await z(w.user.EmployeeId);if(g&&g!="AU02"){const e={$schema:"http://powerbi.com/product/schema#basic",target:{table:o[0].table,column:o[0].column},operator:"In",values:[w.user.Location]};let c;c=document.getElementById("bumaLevelContainer"),s=t.get(c);try{await s.setFilters([e])}catch(I){console.log(I)}}const m=_(o[0].sessionStorageName);v.value=g=="AU02"?"":w.user.Location;const R=v.value?[v.value]:[],D=m&&m.length>0?m:R;let U=p.filter(e=>e.type==="slicer"&&e.title===o[0].slicerTitle)[0];if(U&&D.length>0){const e={filters:[{$schema:"http://powerbi.com/product/schema#basic",operator:"In",values:[...D],target:{table:o[0].table,column:o[0].column},filterType:1,requireSingleSelection:!0}]};try{g!=="AU02"&&(await U.setSlicerState(e),console.log("success set slicer site"))}catch(c){console.log(c)}y(o[0].slicerTitle,"In",[...D],[])}o.forEach(async e=>{let r=(await(await s.getActivePage()).getVisuals()).filter(l=>l.type==="slicer"&&l.title===e.slicerTitle)[0];const n=_(e.sessionStorageName);if(r)if(n&&n.length>0){const l={filters:[{$schema:"http://powerbi.com/product/schema#basic",operator:"In",values:n,target:{column:e.column,table:e.table},filterType:1,requireSingleSelection:!1}]};try{await r.setSlicerState(l)}catch(u){console.log(u)}}else try{const u=(await r.getSlicerState()).filters[0].values;u&&u.length>0&&y(e.slicerTitle,"In",u,[])}catch(l){console.log(l)}})}),s.on("error",async function(i){i.detail=="TokenExpired"&&await A(()=>{q()}),s.off("error")})}}catch(a){console.log(a)}},A=async a=>{await k.dispatch($.GET_PBI_CONFIG,{reportName:f.reportName,isPublic:f.isPublic,reportId:f.pbiReportId,workspaceId:f.pbiWorkspaceId}),a()},_=a=>{const t=sessionStorage.getItem(a);return t?JSON.parse(t):[]},q=async()=>{await s.setAccessToken(S.value.embedToken.token),await s.refresh()},B=()=>{const t=G(new Date),h=Date.parse(S.value.embedToken.expiration)-t,p=ae*60*1e3;h<=p&&A(function(){q()})},y=async(a,t,i,h)=>{let p=[];i.length>0&&t=="In"?p=[...i]:i.length>0&&t=="NotIn"&&(p=h.filter(m=>m!=""&&i.indexOf(m)==-1)),console.log(p);const g=o.find(m=>m.slicerTitle==a);g&&sessionStorage.setItem(g.sessionStorageName,JSON.stringify(p))},j=a=>{let t={siteDescription:"",componentName:"",modelUnit:"",equipment:""};a.forEach(i=>{i.target.column=="site_description"?t.siteDescription=i.equals:i.target.column=="component_name"?t.componentName=i.equals:i.target.column=="model_unit"?t.modelUnit=i.equals:i.target.column=="equipment"&&(t.equipment=i.equals)}),t.siteDescription!=""&&t.componentName!=""&&t.modelUnit!=""&&t.equipment!=""&&(sessionStorage.setItem(o[0].sessionStorageName,JSON.stringify([t.siteDescription])),sessionStorage.setItem(o[4].sessionStorageName,JSON.stringify([t.componentName])),sessionStorage.setItem(o[2].sessionStorageName,JSON.stringify([t.modelUnit])),sessionStorage.setItem("IronPortalDashboardFilter-Equipment",JSON.stringify([t.equipment])),J())},J=()=>{const a=window.open("#/ironportal-dashboard/equipment","_blank");(!a||a.closed||typeof a.closed>"u")&&M("Please allow pop-up permission on your browser if equipment page is not opened in a new tab.","OK")};return Z(async()=>{await A(()=>{F()}),P.value=setInterval(()=>{B()},se)}),H(async()=>{P.value&&clearInterval(P.value)}),(a,t)=>{const i=oe("loading");return ee((te(),ie("div",{id:"bumaLevelContainer","element-loading-background":"#2d2b39b3",ref_key:"reportContainer",ref:N,class:"my-5",style:{height:"90vh"}},null,512)),[[i,x.value||C.value]])}}});export{ge as _};
