import{d as V}from"./pinia-BjOS2_Ao.js";import{c as m,s as h,a as v}from"./index-BuVmIl8K.js";import{e as U,g as N,q as F,h as T,G as w}from"./urls-CvqtYZA-.js";import{e as g,_ as E}from"./lodash-DrHMlsdo.js";import{u as _}from"./useCameraStore-BwXVJhPe.js";import{u as y}from"./authentication-handler-Pueb_EI7.js";import{j as L}from"./urls-CPQ2HRXU.js";import{b as C}from"./useDefectsFormStore-41UTMhiG.js";import{r as B,s as M}from"./string-to-imageinfo-converter-Cdr1iOkP.js";import{w as K}from"./helpers-wUOLw-dU.js";import{C as d,d as $,c as S,b as D,T as A}from"./prev-val-handler-DvA3D_kF.js";const j="https://digital-bumaau-dev-apm-001.azure-api.net/dinspect/api/defect_header/get_data_list_by_param",x="https://digital-bumaau-dev-apm-001.azure-api.net/dinspect/api/version_history/get_blank_service_sheet",re=V({id:"DmaPreviewForm",state:()=>({stateGroups:[],stateSelectedSubGroups:[],stateGeneralForm:{},stateModelId:"",statePsTypeId:"",stateWorkOrder:"",stateUnitNumber:"",stateEmployee:{},stateSelectedGroup:void 0,stateServiceSheets:[],stateFormPreview:!0,stateDefectList:[],stateError:"",stateStoredSuspensionCylinderValue:[],stateStoredAdjustedSuspensionCylinderValue:[],stateStoredAdjustmentOptionValue:"",stateIsFormSelectedByOtherSupervisor:!1,stateSelectedWorkorder:{},statePreviousTandemTasks:[],stateRefreshDataMultiDefect:!1,stateMultiDefectList:{},stateItemTriggerDisabledValue:{},stateItemKeyWithTriggeredDisabledKey:{},stateSelectedBrakeTypeDropdown:""}),getters:{serviceSheets:e=>e.stateServiceSheets,groups:e=>e.stateGroups,selectedSubGroups:e=>e.stateSelectedSubGroups,generalForm:e=>e.stateGeneralForm,employee:e=>e.stateEmployee,selectedGroup:e=>e.stateSelectedGroup,formPreview:e=>e.stateFormPreview,preRiskImages:()=>_().ImageObjects.find(t=>t.Id==="preview-risk"),errorMessage:e=>e.stateError,percentageTaskProgressAllTab:e=>K(e.stateGroups),refreshDataMultiDefect:e=>e.stateRefreshDataMultiDefect,multiDefectList:e=>e.stateMultiDefectList,itemTriggerDisabledValue:e=>e.stateItemTriggerDisabledValue,SelectedBrakeTypeDropdown:e=>e.stateSelectedBrakeTypeDropdown},actions:{updateSelectedBrakeTypeDropdownValue(e){this.stateSelectedBrakeTypeDropdown=e},setRefreshDataMultiDefect(e){this.stateRefreshDataMultiDefect=e},setItemTriggerDisabledValue(e){e.subGroup[0].taskGroup.forEach(t=>{t.task.forEach(a=>{a.taskType=="inline"?a.items.forEach(s=>{s.disabledByItemKey&&(s.disabledByItemKey in this.stateItemTriggerDisabledValue||(this.stateItemTriggerDisabledValue[s.disabledByItemKey]="",this.stateItemKeyWithTriggeredDisabledKey[s.key]=s.disabledByItemKey));const o=s.categoryItemType==d.BRAKE_TYPE_DROPDOWN,r=a.categoryTaskType&&a.categoryTaskType==$.BRAKE_TYPE_DROPDOWN;o&&r&&this.updateSelectedBrakeTypeDropdownValue(s.value)}):a.taskType=="table"&&a.items.forEach(s=>{for(const o in s)s[o].disabledByItemKey&&(s[o].disabledByItemKey in this.stateItemTriggerDisabledValue||(this.stateItemTriggerDisabledValue[s[o].disabledByItemKey]="",this.stateItemKeyWithTriggeredDisabledKey[s[o].key]=s[o].disabledByItemKey))})})}),e.subGroup[0].taskGroup.forEach(t=>{t.task.forEach(a=>{a.taskType=="inline"?a.items.forEach(s=>{s.key in this.stateItemTriggerDisabledValue&&(this.stateItemTriggerDisabledValue[s.key]=s.value)}):a.taskType=="table"&&a.items.forEach(s=>{for(const o in s)s[o].disabledByItemKey&&s[o].key in this.stateItemTriggerDisabledValue&&(this.stateItemTriggerDisabledValue[s[o].key]=s[o].value)})})})},async postGenerateServiceSheet(e,t,a){this.stateDefectList=[];const s={employee:{id:e,name:t},modelId:this.stateModelId,psTypeId:this.statePsTypeId,workOrder:this.stateWorkOrder,unitNumber:this.stateUnitNumber,siteId:a},o={ver:"v1"};try{const r=await m.post(`${U}?${new URLSearchParams(o).toString()}`,s);if(r.data.statusCode!=200)this.stateError=r.data.result.message;else if(this.stateError="",r.data.result.message=="Cannot Access With Different Supervisor")this.stateIsFormSelectedByOtherSupervisor=!0;else try{this.stateGeneralForm=r.data.result.content.general,this.stateServiceSheets=r.data.result.content.serviceSheet,this.getGroups(),this.getTaskProgress(),r.data.result.content.serviceSheet.forEach(n=>{this.setItemTriggerDisabledValue(n)}),this.stateSelectedGroup=this.groups[0];const i=_();i.setCurrent("preview-risk"),i.clearCurrent(),g.isArray(this.generalForm.riskAssesment[0].value)&&(this.generalForm.riskAssesment[0].value=B(this.generalForm.riskAssesment[0].value),this.preRiskImages.ImageInfos=M(this.preRiskImages.ImageInfos),this.generalForm.riskAssesment[0].value.forEach(n=>{this.preRiskImages.ImageInfos.push(n.image)}))}catch(i){y(i),this.stateError=i.response.data.result.message,h("IRONS",i)}}catch(r){y(r),this.stateError=r.response.data.result.message,h("IRONS",r)}},async getEmptyForm(){const e=v(),t=e.user.SiteId,a={ver:"v1",modelId:this.stateModelId,psTypeId:this.statePsTypeId,siteId:t};try{const s=await m.get(`${x}?${new URLSearchParams(a).toString()}`);if(s.data.statusCode!=200)this.stateError=s.data.result.message;else if(this.stateError="",s.data.result.message=="Cannot Access With Different Supervisor")this.stateIsFormSelectedByOtherSupervisor=!0;else try{s.data.result.content.general?(this.stateGeneralForm=s.data.result.content.general,this.stateServiceSheets=s.data.result.content.serviceSheet,this.getGroups(),this.stateSelectedGroup=this.groups[0]):this.stateError=`${this.stateModelId} form for service size ${this.statePsTypeId} is not implemented yet on ${e.user.Location}`}catch(o){y(o),this.stateError=o.response.data.result.message}}catch(s){y(s),this.stateError=s.response.data.result.message,h("IRONS",s)}},getGroups(){let e=[{id:this.generalForm.id||"General",modelId:this.generalForm.modelId,psTypeId:this.generalForm.psTypeId,workOrder:this.generalForm.workOrder,groupName:"General",groupSeq:1,key:"1",headerId:"g1",isActive:this.generalForm.isActive&&this.generalForm.isActive.toString()||"",isDeleted:this.generalForm.isDeleted&&this.generalForm.isDeleted.toString()||"",createdBy:this.generalForm.createdBy,createdDate:this.generalForm.createdDate,updatedBy:"",updatedDate:this.generalForm.updatedDate,_rid:this.generalForm._rid,_self:this.generalForm._self,_etag:this.generalForm._etag,_attachments:this.generalForm._attachments,_ts:this.generalForm._ts,isSelected:!0,groupLabel:"General",subGroup:[],totalTask:0,doneTask:0}];this.serviceSheets.forEach(t=>{const a={id:t.id||t.groupName,modelId:t.modelId,psTypeId:t.psTypeId,workOrder:t.workOrder,groupName:t.groupName,groupSeq:t.groupSeq,key:t.key,headerId:t.headerId,isActive:t.isActive,isDeleted:t.isDeleted,createdBy:t.createdBy,createdDate:t.createdDate,updatedBy:t.updatedBy,updatedDate:t.updatedDate,_rid:t._rid,_self:t._self,_etag:t._etag,_attachments:t._attachments,_ts:t._ts,isSelected:!1,groupLabel:t.subGroup[0].name,subGroup:t.subGroup,totalTask:0,doneTask:0,isDisable:g.isUndefined(t.isDisable)?"false":t.isDisable};a.subGroup.forEach(s=>{s.taskGroup.forEach(o=>{o.task.forEach(r=>{!g.isUndefined(r.adjustment)&&(r.adjustment.rating!=""||r.adjustment.commentValue!=""||r.adjustment.measurement!="")&&(r.isShowAdjustmentRow=!0),!g.isUndefined(r.replacement)&&(r.replacement.rating!=""||r.replacement.commentValue!=""||r.replacement.measurement!="")&&(r.isShowReplacementRow=!0),!g.isUndefined(r.cleaned)&&r.cleaned.rating!=""&&(r.isShowCleanedRow=!0)})})}),e.push(a)}),e=E.sortBy(e,"groupSeq"),this.stateGroups=e},async getTaskProgress(){const e={ver:"v1"};try{const t={modelId:this.generalForm.modelId,psTypeId:this.generalForm.psTypeId,workOrder:this.generalForm.workOrder,headerId:this.serviceSheets[0].headerId};(await m.post(`${N}?${new URLSearchParams(e).toString()}`,t)).data.result.content.forEach(s=>{const o=this.groups.find(r=>s.group===r.key);o&&(o.doneTask=o.groupName=="DEFECT_IDENTIFIED_SERVICE"&&s.identifiedDefectCount?s.identifiedDefectCount:s.doneTask,o.totalTask=o.groupName=="DEFECT_IDENTIFIED_SERVICE"&&s.identifiedDefectCount?s.identifiedDefectCount:s.totalTask)})}catch(t){y(t),h("IRONS",t),console.log(t)}},setModelAndPsTypeId(e,t,a,s){this.stateModelId=e,this.statePsTypeId=t,this.stateWorkOrder=a,this.stateUnitNumber=s},setShowPreviewForm(e){this.stateFormPreview=e},setSelectedGroup(e){this.stateGroups.forEach(t=>{t.id===e?t.isSelected=!0:t.isSelected=!1}),this.stateSelectedGroup=this.groups.find(t=>t.isSelected),this.stateSelectedGroup.subGroup.length>0&&this.getSubGroups()},getSubGroups(){const e=this.groups.find(t=>t.isSelected);if(e.groupSeq==1)this.stateSelectedSubGroups=[];else{const t=this.serviceSheets.find(a=>a.id?e.id===a.id:e.groupName===a.groupName);this.stateSelectedSubGroups=t.subGroup}},async updateGroupByParam(e){if(e!=="General")try{const t={modelId:this.generalForm.modelId,psTypeId:this.generalForm.psTypeId,workOrder:this.generalForm.workOrder,groupName:e},a={ver:"v1"},s=await m.post(`${F}?${new URLSearchParams(a).toString()}`,t);this.stateSelectedSubGroups=s.data.result.content.subGroup,this.stateSelectedSubGroups.forEach(o=>{o.taskGroup.forEach(r=>{r.task.forEach(i=>{!g.isUndefined(i.adjustment)&&(i.adjustment.rating!=""||i.adjustment.commentValue!=""||i.adjustment.measurement!="")&&(i.isShowAdjustmentRow=!0),!g.isUndefined(i.replacement)&&(i.replacement.rating!=""||i.replacement.commentValue!=""||i.replacement.measurement!="")&&(i.isShowReplacementRow=!0),!g.isUndefined(i.cleaned)&&i.cleaned.rating!=""&&(i.isShowCleanedRow=!0)})})}),this.setItemTriggerDisabledValue(s.data.result.content),await this.getMultiDefectList(),await this.getPreviousTandemValue(),await this.getPreviousBrakePackValue(),await this.getPreviousReplacementValue()}catch(t){y(t),h("IRONS",t),console.log(t)}},async getPreviousTandemValue(){let e=!1,t=!1;this.statePreviousTandemTasks=[],this.stateSelectedSubGroups.forEach(o=>{o.taskGroup.forEach(r=>{r.task.forEach(i=>{(i.rating=="AUTOMATIC_PREVIOUS"||i.rating=="AUTOMATIC")&&(e=!0,this.statePreviousTandemTasks.push(i.key),i.items.forEach(n=>{n.categoryItemType=="previousParamRating"&&n.value!=""&&n.value!="-"&&(t=!0)}))})})});const a=this.stateGeneralForm.status=="Open",s=this.stateGeneralForm.status=="On Progress"&&e&&!t;if(a||s){const o={ver:"v1"};try{const r=await m.post(`${T}?${new URLSearchParams(o).toString()}`,{equipmentNumber:this.generalForm.equipment,modelId:this.generalForm.modelId});let i=[];i=r.data.result.content?r.data.result.content:[],this.stateSelectedSubGroups.forEach(n=>{n.taskGroup.forEach(p=>{p.task.forEach(l=>{(l.rating=="AUTOMATIC_PREVIOUS"||l.rating=="AUTOMATIC")&&i.forEach(c=>{c.key==l.key&&l.items.forEach(async u=>{u.categoryItemType=="previousParamRating"&&u.value!=S(c)&&(u.value=S(c))})})})})})}catch(r){h("IRONS",r),console.log("error get tandem",r)}}},async getPreviousReplacementValue(){if(!this.stateSelectedGroup||this.stateSelectedGroup.key!="ELECTRICAL_SERVICE")return;let e=!1,t=!1;this.statePreviousTandemTasks=[],this.stateSelectedSubGroups.forEach(o=>{o.taskGroup.forEach(r=>{r.task.forEach(i=>{(i.rating=="AUTOMATIC_REPLACEMENT_GAP"||i.rating=="AUTOMATIC_REPLACEMENT")&&(e=!0,this.statePreviousTandemTasks.push(i.key),i.items.forEach(n=>{n.categoryItemType=="previousParamRating"&&n.value!=""&&n.value!="-"&&(t=!0)}))})})});const a=this.stateGeneralForm.status=="Open",s=this.stateGeneralForm.status=="On Progress"&&e&&!t;if(a||s){const o={ver:"v1"};try{const r=await m.post(`${T}?${new URLSearchParams(o).toString()}`,{equipmentNumber:this.generalForm.equipment,modelId:this.generalForm.modelId});let i=[];i=r.data.result.content?r.data.result.content:[],this.stateSelectedSubGroups.forEach(n=>{n.taskGroup.forEach(p=>{p.task.forEach(l=>{(l.rating=="AUTOMATIC_REPLACEMENT_GAP"||l.rating=="AUTOMATIC_REPLACEMENT")&&i.forEach(c=>{c.key==l.key&&l.items.forEach(async u=>{u.categoryItemType=="previousParamRating"&&u.value!=S(c)&&(u.value=S(c))})})})})})}catch(r){h("IRONS",r),console.log("error get tandem",r)}}},setShowNextPage(){const e=this.stateGroups.findIndex(s=>{var o;return s.groupName==((o=this.stateSelectedGroup)==null?void 0:o.groupName)});let t=1,a=this.stateGroups[e+t];for(;!g.isUndefined(a.isDisable)&&a.isDisable=="true";)t++,a=this.stateGroups[e+t];this.setSelectedGroup(a.id),this.getTaskProgress(),this.updateGroupByParam(a.groupName)},setShowPrevPage(){const e=this.stateGroups.findIndex(s=>{var o;return s.groupName==((o=this.stateSelectedGroup)==null?void 0:o.groupName)});let t=1,a=this.stateGroups[e-t];for(;!g.isUndefined(a.isDisable)&&a.isDisable=="true";)t++,a=this.stateGroups[e-t];this.setSelectedGroup(a.id),this.updateGroupByParam(a.groupName)},resetPreview(){this.stateFormPreview=!1,this.stateSelectedGroup=void 0,this.stateItemTriggerDisabledValue={},this.stateItemKeyWithTriggeredDisabledKey={}},async getDefectList(){const e={ver:"v1"},t={workorder:this.generalForm.workOrder};try{const a=await m.post(`${j}?${new URLSearchParams(e).toString()}`,t);this.stateDefectList=a.data.result.content,this.stateDefectList.forEach(async s=>{if(s.taskNumber=Number(s.taskNo.replace(/[^0-9]+/g,"")),s.category=="NORMAL"&&s.defectType=="NO"){const o={ver:"v1"},r={servicesheetDetailId:s.serviceSheetDetailId,taskId:s.taskId},i=await m.post(`${L}?${new URLSearchParams(o).toString()}`,r),n=JSON.parse(i.data.result.content.detail.actions);n.forEach((p,l)=>{s.defectAction=E.isUndefined(s.defectAction)?""+p:s.defectAction,l+1<n.length&&(s.defectAction=s.defectAction+", ")})}}),this.stateDefectList=E.orderBy(this.stateDefectList,["taskNumber"],["asc"])}catch(a){y(a),h("IRONS",a),console.log(a)}},async closeForm(){const e=v(),t={id:e.user.EmployeeId,name:e.user.Name},a={ver:"v1"},s=[{propertyName:"status",propertyValue:"Close"},{propertyName:"serviceEnd",propertyValue:"<<ServerDateTime>>"},{propertyName:"tsServiceEnd",propertyValue:"<<ServerTimeStamp>>"},{propertyName:"updatedBy",propertyValue:JSON.stringify(t)},{propertyName:"updatedDate",propertyValue:"<<ServerDateTime>>"}],o={id:this.generalForm.id,updateParams:[{keyValue:"GENERAL",propertyParams:s}],employee:t};try{return await m.post(`${w}?${new URLSearchParams(a).toString()}`,o),!0}catch(r){return y(r),h("IRONS",r),console.log(r),!1}},changePreviewForm(e){this.stateFormPreview=e},setSelectedWorkOrder(e){this.stateSelectedWorkorder=e},pushDataToSuspensionCylinderStoredValue(e){this.stateStoredSuspensionCylinderValue=e},pushDataToAdjustedSuspensionCylinderStoredValue(e){this.stateStoredAdjustedSuspensionCylinderValue=e},updateStoredAdjustmentOptionValue(e){this.stateStoredAdjustmentOptionValue=e},resetDefectMultiList(){this.stateMultiDefectList={}},async getMultiDefectList(){const e=C(),t=[],a=[];this.stateSelectedSubGroups.forEach(s=>{s.taskGroup.forEach(o=>{o.task.forEach(r=>{r.category=="NORMAL"&&r.taskValue=="2"&&(a.push(r.key),t.push(new Promise(i=>{var n;e.getMultipleDefectList(this.stateGeneralForm.workOrder,r.key,(n=this.selectedGroup)==null?void 0:n.id).then(p=>{i(p)})})))})})}),await Promise.all(t).then(async s=>{s.forEach((o,r)=>{this.stateMultiDefectList[a[r]]=o})})},setSerialNumberGeneral(e){this.stateGeneralForm.serialNumber=e},updateSMUONGeneral(e){const{value:t,smuBy:a,smuDate:s}=e;this.generalForm.smu=t,this.generalForm.smuBy=a,this.generalForm.smuDate=s},updateSMUImages(e){this.stateGeneralForm.imageEquipment=e},async getPreviousBrakePackValue(){let e=!0;e=this.checkPreviousBrakePackValueAlreadyFilled(this.stateSelectedSubGroups[0]);let t=[];if(e)return;t=await this.getPreviousBrakePackData();const a=r=>{let i="";switch(r.categoryItemType){case d.PREVIOUS_VALUE_PISTON_A:i=r.previousData.lastValuePistonA??"";break;case d.PREVIOUS_VALUE_PISTON_B:i=r.previousData.lastValuePistonB??"";break;case d.PREVIOUS_VALUE_PISTON_RESULT:i=r.previousData.lastValuePistonResult??"";break;case d.PREVIOUS_VALUE_PISTON_PERCENTAGE:i=r.previousData.lastValuePistonPercentage??"";break;case d.PREVIOUS_VALUE_UOM:i=r.previousData.lastUom??"";break;case d.PREVIOUS_VALUE_PISTON_RATING:i=r.previousData.lastRating??"";break}return i};let s="",o="";for(const r of this.stateSelectedSubGroups[0].taskGroup)for(const i of r.task){o||(o=i.key);const n=i,p=n.category==D.CBM,l=n.rating==A.OIL_COOLED;if(p&&l){for(const c of t)if(c.key==n.key)for(const u of n.items){s||(s=u.key);const I=u.categoryItemType==d.PREVIOUS_VALUE_PISTON_A,f=u.categoryItemType==d.PREVIOUS_VALUE_PISTON_B,G=u.categoryItemType==d.PREVIOUS_VALUE_PISTON_RESULT,O=u.categoryItemType==d.PREVIOUS_VALUE_UOM,k=u.categoryItemType==d.PREVIOUS_VALUE_PISTON_RATING,R=u.categoryItemType==d.PREVIOUS_VALUE_PISTON_PERCENTAGE,b=u.value==""||u.value=="-";if((I||f||G||O||k||R)&&b){const P=a({categoryItemType:u.categoryItemType,previousData:c});P&&!u.updatedDate&&(u.value=P)}}}}},async getPreviousBrakePackData(){try{const e={ver:"v1"},t=await m.post(`${T}?${new URLSearchParams(e).toString()}`,{equipmentNumber:this.generalForm.equipment,modelId:this.generalForm.modelId});return t.data.result.content?t.data.result.content:[]}catch(e){return h("IRONS",e),console.log("error get tandem",e),[]}},checkPreviousBrakePackValueAlreadyFilled(e){let t=!0;for(const a of e.taskGroup)for(const s of a.task){const o=s,r=o.category==D.CBM,i=o.rating==A.OIL_COOLED;if(r&&i)for(const n of o.items){const p=n.categoryItemType==d.PREVIOUS_VALUE_PISTON_A,l=n.categoryItemType==d.PREVIOUS_VALUE_PISTON_B,c=n.categoryItemType==d.PREVIOUS_VALUE_PISTON_RESULT,u=n.categoryItemType==d.PREVIOUS_VALUE_UOM,I=n.categoryItemType==d.PREVIOUS_VALUE_PISTON_RATING,f=n.categoryItemType==d.PREVIOUS_VALUE_PISTON_PERCENTAGE;if((p||l||c||u||I||f)&&(n.value==""||n.value=="-")){t=!1;break}}}return t}}});export{re as u};
