import{u as G,b as oe,G as ae}from"./index-BCnwA6yE.js";import{A as ie,M as se}from"./PbiEmbeddedEnums-BaTTPSF0.js";import{p as v}from"./powerbi-client-BGzjSA60.js";import{u as j}from"./vuex-BbOKrtVp.js";import{d as le}from"./date-format-BASVuupi.js";import{a as ce,b as ne,g as pe}from"./utils-CryoXyYA.js";import{o as me}from"./vue-router-iNp9kJ0K.js";import{u as ue}from"./dynamicGraphHierarchy-CaKaRj9m.js";import{k as V,r as S,c as q,o as M,y as de,p as H,aa as fe,Y as he,a7 as be,L as ge,q as _e}from"./@vue-BypzYtbH.js";import{_ as W}from"./nw-img-vue-CR837WER.js";import"./object-path-BACu75q6.js";import"./attr-accept-BWI1aNlo.js";import"./pinia-BjOS2_Ao.js";import"./crypto-js-BZehCumu.js";import"./cron-Ci8nYs3o.js";import"./luxon-C_T8jI2d.js";import"./dexie-CWyjz2Lo.js";import"./element-plus-C5R56mia.js";import"./dayjs-C7SXsQPH.js";import"./lodash-Cr9vlq0V.js";import"./resize-observer-polyfill-B1PUzC5B.js";import"./normalize-wheel-xcxZ5rdH.js";import"./mitt-C1xD_ZTF.js";import"./@popperjs-WhmJkuoZ.js";import"./async-validator-DK9uouaC.js";import"./axios-N3crNZ6y.js";import"./vue-axios-BaogFJPH.js";import"./sweetalert2-DK0FVkv3.js";import"./@azure-DwL0pga8.js";import"./uuid-SoommWqA.js";import"./vue-inline-svg-Bgl3eqMC.js";import"./vee-validate-C_msoaAA.js";import"./@microsoft-C248spM2.js";import"./@nevware21-CKApUIxW.js";import"./moment-C5S46NFB.js";import"./urls-Cljsxeb-.js";const ye=5,Te=3e5,ve=V({__name:"PbiReportRealtimeGraph",props:["reportName","visibletab","isPublic","pbiReportId","pbiWorkspaceId","isHideVisualHeaders","isTransparent","filterEquipment"],emits:["handle-click"],setup(N,{emit:R}){const{configTargetY1:g,getHierarchyDataY1:k,defaultY1:_,getFilterY:L}=ue(),P=G(),f=N,E=j(),a=[{column:"site_description",table:"vw_f_pm_ehms_oms_3dphornet_sensor_last_hour",slicerTitle:"site_slicer",btnClearTitles:["btn_clear_site"],sessionStorageName:"IronPortalDashboardFilter-Site"},{column:"equipment_hierarchy",table:"vw_f_pm_ehms_oms_3dphornet_sensor_last_hour",slicerTitle:"group_slicer",btnClearTitles:["btn_clear_group"],sessionStorageName:"IronPortalDashboardFilter-Group"},{column:"model_unit",table:"vw_f_pm_ehms_oms_3dphornet_sensor_last_hour",slicerTitle:"model_slicer",btnClearTitles:["btn_clear_model"],sessionStorageName:"IronPortalDashboardFilter-Model"},{column:"equipment",table:"vw_f_pm_ehms_oms_3dphornet_sensor_last_hour",slicerTitle:"equipment_slicer",btnClearTitles:["btn_clear_equipment"],sessionStorageName:"IronPortalDashboardFilter-Equipment"},{column:"component_type",table:"vw_f_pm_ehms_oms_3dphornet_sensor_last_hour",slicerTitle:"comptype_slicer",btnClearTitles:["btn_clear_comptype"],sessionStorageName:"IronPortalDashboardFilter-ComponentType"},{column:"component_desc",table:"vw_f_pm_ehms_oms_3dphornet_sensor_last_hour",slicerTitle:"component_slicer",btnClearTitles:["btn_clear_component"],sessionStorageName:"IronPortalDashboardFilter-Component"}],Y=S();let s;const A=S(0),I=S(""),y=S(!1),J=S(!0),z=q(()=>E.getters.getIsDashboardConfigLoading),w=q(()=>E.getters.getDashboardConfigPbi),K=()=>{const c={type:"report",tokenType:v.models.TokenType.Embed||"",accessToken:w.value.embedToken.token||"",embedUrl:w.value.embedReport[0].embedUrl||"",id:w.value.embedReport[0].reportId||"",permissions:v.models.Permissions.All,settings:{panes:{filters:{visible:!1},pageNavigation:{visible:typeof f.visibletab>"u"?!0:f.visibletab}}}};return f.isTransparent&&(c.settings.background=v.models.BackgroundType.Transparent),c},Q=async()=>{try{if(typeof w.value<"u"){const c=K();let d=new v.service.Service(v.factories.hpmFactory,v.factories.wpmpFactory,v.factories.routerFactory);Y.value&&(s=d.embed(Y.value,c)),s.off("loaded"),s.on("loaded",async()=>{let n=[],p=[];await s.getPages().then(e=>{n=e}).catch(e=>{console.log("error get pages",e)}),await n.find(e=>e.displayName==="Realtime").getVisuals().then(e=>{p=e}).catch(e=>{console.log("error get visuals",e)});const T=await ce(P.user.EmployeeId);if(T&&T!=="AU02"){const e={$schema:"http://powerbi.com/product/schema#basic",target:{table:a[0].table,column:a[0].column},operator:"In",values:[P.user.Location]};let l;l=document.getElementById("realtimeGraphContainer"),s=d.get(l);try{await s.setFilters([e])}catch(m){console.log(m)}}s.off("dataSelected"),s.on("dataSelected",async e=>{var m,r;console.log(e.detail);let l=e.detail;if(((m=l==null?void 0:l.visual)==null?void 0:m.title)==="component_slicer"&&setTimeout(async()=>{const t=l==null?void 0:l.dataPoints;let o=p.filter(u=>u.type==="slicer"&&u.title==="Y1")[0];const i=await p.filter(u=>u.title==="table_sample")[0].exportData(),F=ne(i?i.data:"");let b;b={filters:[{$schema:"http://powerbi.com/product/schema#hierarchy",target:g,filterType:9,hierarchyData:_}]};try{y.value=!0,await o.setSlicerState(b),console.log("slicer Y1 successfully set")}catch(u){console.error("slicer Y1 error",u)}finally{y.value=!1}if((t==null?void 0:t.length)>0){let u=[];t.forEach(ke=>{u=[...u,...L(F,1)]}),b={filters:[{$schema:"http://powerbi.com/product/schema#hierarchy",target:g,filterType:9,hierarchyData:u}]}}else b={filters:[{$schema:"http://powerbi.com/product/schema#hierarchy",target:g,filterType:9,hierarchyData:_}]};try{y.value=!0,await o.setSlicerState(b),console.log("slicer Y1 successfully set")}catch(u){console.error("slicer Y1 error",u)}finally{y.value=!1}},1500),e.detail.visual.type=="slicer"&&e.detail.visual.title!="Y1"){let t=p.filter(o=>o.type==="slicer"&&o.title===e.detail.visual.title)[0];try{y.value=!0;const o=await t.getSlicerState();if(o){let C=[],i="",F=[];if(o.filters.length>0&&(F=[...(r=o.filters[0])==null?void 0:r.values],i=o.filters[0].operator),F.length==0||o.filters[0].operator=="NotIn"){const b=await t.exportData();C=pe(b?b.data:"")}x(e.detail.visual.title,i,F,C)}}catch(o){console.log(o)}finally{y.value=!1}}}),s.off("buttonClicked"),s.on("buttonClicked",async e=>{if(console.log(e.detail),e.detail.title=="Export_PDF"){X();return}if(!e.detail.title.includes("clear")&&!e.detail.title.includes("clr"))return;const l=a.findIndex(r=>{var t;return(t=r.btnClearTitles)==null?void 0:t.includes(e.detail.title)});if(l==-1)return;for(let r=l;r<a.length;r++){const t=a[r];x(t.slicerTitle,"",[],[])}if(a[0].btnClearTitles.findIndex(r=>e.detail.title.includes(r))!=-1){const r=I.value==""?[]:{filters:[{$schema:"http://powerbi.com/product/schema#basic",operator:"In",values:[I.value],target:{table:a[0].table,column:a[0].column},filterType:1,requireSingleSelection:!0}]};try{await(await n.find(i=>i.isActive).getVisuals()).filter(i=>i.type==="slicer"&&i.title===a[0].slicerTitle)[0].setSlicerState(r),console.log("success set site again"),x(a[0].slicerTitle,"In",I.value==""?[]:[],[])}catch(t){console.log(t)}}if(e.detail.title&&e.detail.title==="btn_clear_component"){let r=p.filter(o=>o.type==="slicer"&&o.title==="Y1")[0];const t={filters:[{$schema:"http://powerbi.com/product/schema#hierarchy",target:g,filterType:9,hierarchyData:_}]};try{await r.setSlicerState(t),console.log("slicer Y1 successfully set")}catch(o){console.error("slicer Y1 error",o)}}});const h=O(a[0].sessionStorageName);I.value=T=="AU02"?"":P.user.Location;const ee=I.value?[I.value]:[],$=h&&h.length>0?h:ee,te={filters:[{$schema:"http://powerbi.com/product/schema#basic",operator:"In",values:[...$],target:{table:a[0].table,column:a[0].column},filterType:1,requireSingleSelection:!0}]};let re=p.filter(e=>e.type==="slicer"&&e.title===a[0].slicerTitle)[0];try{T!=="AU02"&&(await re.setSlicerState(te),console.log("success set slicer site"))}catch(e){console.log(e)}x(a[0].slicerTitle,"In",[...$],[]);try{a.forEach(async e=>{let l=p.filter(r=>r.type==="slicer"&&r.title===e.slicerTitle)[0];const m=O(e.sessionStorageName);if(m&&m.length>0){const r={filters:[{$schema:"http://powerbi.com/product/schema#basic",operator:"In",values:m,target:{column:e.column,table:e.table},filterType:1,requireSingleSelection:!1}]};try{await l.setSlicerState(r)}catch(t){console.log(t)}if(m&&m.length>0&&e.slicerTitle==="component_slicer"){let t=p.filter(i=>i.type==="slicer"&&i.title==="Y1")[0],o=[];m.forEach(i=>{o=[...o,...k(i)]});const C={filters:[{$schema:"http://powerbi.com/product/schema#hierarchy",target:g,filterType:9,hierarchyData:o}]};try{await t.setSlicerState(C),console.log("slicer Y1 successfully set")}catch(i){console.error("slicer Y1 error",i)}}}else try{const r=await l.getSlicerState();if(r.filters[0]){const t=r.filters[0].values;t&&t.length>0&&x(e.slicerTitle,"In",t,[])}}catch(r){console.log(r)}})}catch(e){console.log(e)}}),s.on("error",async function(n){n.detail=="TokenExpired"&&await U(async()=>{await B()}),s.off("error")})}}catch(c){console.log(c)}},X=()=>{s&&s.print()},U=async c=>{await E.dispatch(ie.GET_PBI_CONFIG,{reportName:f.reportName,isPublic:f.isPublic,reportId:f.pbiReportId,workspaceId:f.pbiWorkspaceId}),c()},O=c=>{const d=sessionStorage.getItem(c);return d?JSON.parse(d):[]},B=async()=>{await s.setAccessToken(w.value.embedToken.token),await s.refresh()},Z=()=>{const d=le(new Date),p=Date.parse(w.value.embedToken.expiration)-d,D=ye*60*1e3;p<=D&&U(async()=>{await B()})},x=async(c,d,n,p)=>{let D=[];n.length>0&&d=="In"?D=[...n]:n.length>0&&d=="NotIn"&&(D=p.filter(h=>h!=""&&n.indexOf(h)==-1));const T=a.find(h=>h.slicerTitle==c);T&&sessionStorage.setItem(T.sessionStorageName,JSON.stringify(D))};return M(async()=>{await U(()=>{Q(),J.value=!1}),A.value=setInterval(()=>{Z()},Te)}),me(()=>{A.value&&clearInterval(A.value)}),(c,d)=>{const n=he("loading");return de((H(),fe("div",{id:"realtimeGraphContainer","element-loading-background":"#2d2b39b3",ref_key:"reportContainer",ref:Y,class:"my-2",style:{height:"71.5vh"}},null,512)),[[n,z.value||y.value]])}}}),Se=W(ve,[["__scopeId","data-v-ca32a9aa"]]),Ie="AM-EHM-3DP-Realtime",we="a9befe6f-7bc4-4d4a-91c1-8715b01416c5",De="d90b69f1-3a2e-423e-9e27-e341dc02a972",Ce=V({__name:"Index",setup(N){const R=j(),g=G(),k=S(!1),_=S(!1),P=setInterval(()=>{_.value&&(k.value=!0,f())},1*60*1e3),f=async()=>{const a={email:g.user.Email,ver:"v1"};if(k.value){try{await oe.get(ae,"",new URLSearchParams(a).toString())}catch(Y){console.log(Y)}k.value=!1}};return be(()=>{R.commit(se.SET_PBI_URL,"https://digital-bumaau-dev-apm-001.azure-api.net/amadm")}),M(()=>{_.value=!0}),ge(()=>{_.value=!1,clearInterval(P)}),(E,a)=>(H(),_e(Se,{reportName:Ie,visibletab:!1,isPublic:!1,isTransparent:!0,pbiReportId:we,pbiWorkspaceId:De,isHideVisualHeaders:!0,class:"dashboard"}))}}),pt=W(Ce,[["__scopeId","data-v-86e52d18"]]);export{pt as default};
