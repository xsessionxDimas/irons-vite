import{a as Q,c as de,G as fe}from"./index-BuVmIl8K.js";import{u as X,A as he,M as ge}from"./usePbiEmbeddedStore-Bda_75jS.js";import{p as d}from"./powerbi-client-99lwt5rM.js";import{k as be}from"./date-format-8-IvfSl3.js";import{a as ye,d as z,g as Te}from"./utils-BpQp1sv3.js";import{o as Se}from"./vue-router-iNp9kJ0K.js";import{u as _e}from"./dynamicGraphHierarchy-CaKaRj9m.js";import{k as Z,g as ve,r as I,c as K,o as ee,y as Ie,p as te,aa as we,Y as De,a7 as Ye,L as Ce,q as Fe}from"./@vue-BypzYtbH.js";import{_ as re}from"./nw-img-vue-CR837WER.js";import"./pinia-BjOS2_Ao.js";import"./object-path-DPahbflh.js";import"./@popperjs-BaMZbQYT.js";import"./deepmerge-oeePEK50.js";import"./crypto-js-BeOoaXQg.js";import"./cron-De-pTz2b.js";import"./luxon-C_T8jI2d.js";import"./dexie-CWyjz2Lo.js";import"./vuex-BbOKrtVp.js";import"./element-plus-BeWdvTRa.js";import"./dayjs-D0x2Df_K.js";import"./lodash-DrHMlsdo.js";import"./resize-observer-polyfill-B1PUzC5B.js";import"./normalize-wheel-D6ofg2JO.js";import"./mitt-C1xD_ZTF.js";import"./async-validator-DK9uouaC.js";import"./axios-CU9oF0EU.js";import"./vue-axios-BaogFJPH.js";import"./sweetalert2-CppYEwAE.js";import"./@azure-DwL0pga8.js";import"./uuid-SoommWqA.js";import"./vue-inline-svg-Bgl3eqMC.js";import"./vee-validate-C_msoaAA.js";import"./@microsoft-C248spM2.js";import"./@nevware21-CKApUIxW.js";import"./btech-analytics-wrapper-DOvMtwpJ.js";import"./posthog-js-CbYOvutT.js";import"./vue-i18n-CbVMwo04.js";import"./@intlify-YGwFW6EB.js";import"./prismjs-BrsEfPfk.js";import"./moment-C5S46NFB.js";import"./urls-Cljsxeb-.js";const Pe=5,ke=3e5,Ee=Z({__name:"PbiReportDynamicGraph",props:["reportName","visibletab","isPublic","pbiReportId","pbiWorkspaceId","isHideVisualHeaders","isTransparent","filterEquipment"],emits:["handle-click"],setup(G,{emit:M}){const{configTargetY1:w,configTargetY2:S,defaultY1:D,defaultY2:U,getFilterY:Y}=_e(),x=Q(),b=G,C=X(),A=ve();A==null||A.appContext.config.globalProperties.$config;const n=[{column:"site Desc",table:"site_health",schema:"basic",filterType:d.models.FilterType.Basic,slicerTitle:"site_slicer",btnClearTitles:["btn_clear_site"],sessionStorageName:"IronPortalDashboardFilter-Site"},{column:"equipment_group",table:"equipment_health",schema:"basic",filterType:d.models.FilterType.Basic,slicerTitle:"group_slicer",btnClearTitles:["btn_clear_group"],sessionStorageName:"IronPortalDashboardFilter-Group"},{column:"model_unit",table:"equipment_health",schema:"basic",filterType:d.models.FilterType.Basic,slicerTitle:"model_slicer",btnClearTitles:["btn_clear_model"],sessionStorageName:"IronPortalDashboardFilter-Model"},{column:"equipment",table:"equipment_health",schema:"basic",filterType:d.models.FilterType.Basic,slicerTitle:"equipment_slicer",btnClearTitles:["btn_clear_equipment"],sessionStorageName:"IronPortalDashboardFilter-Equipment"},{column:"component_type",table:"Component_DIM",schema:"advanced",filterType:d.models.FilterType.Advanced,slicerTitle:"comptype_slicer",btnClearTitles:["btn_clear_comptype"],sessionStorageName:"IronPortalDashboardFilter-ComponentType"},{column:"component_name",table:"Component_DIM",schema:"advanced",filterType:d.models.FilterType.Advanced,slicerTitle:"component_slicer",btnClearTitles:["btn_clear_component"],sessionStorageName:"IronPortalDashboardFilter-Component"}],N=I();let p;const B=I(0),F=I(""),L=I(!1),ae=I(!0),ie=K(()=>C.getIsDashboardConfigLoading),P=K(()=>C.getDashboardConfigPbi),oe=()=>{const c={type:"report",tokenType:d.models.TokenType.Embed||"",accessToken:P.value.embedToken.token||"",embedUrl:P.value.embedReport[0].embedUrl||"",id:P.value.embedReport[0].reportId||"",permissions:d.models.Permissions.All,settings:{panes:{filters:{visible:!1},pageNavigation:{visible:typeof b.visibletab>"u"?!0:b.visibletab}},visualSettings:{visualHeaders:[{settings:{visible:!b.isHideVisualHeaders}}]}}};return b.isTransparent&&(c.settings.background=d.models.BackgroundType.Transparent),c},se=async()=>{try{if(typeof P.value<"u"){const c=oe();let f=new d.service.Service(d.factories.hpmFactory,d.factories.wpmpFactory,d.factories.routerFactory);N.value&&(p=f.embed(N.value,c)),p.off("loaded"),p.on("loaded",async()=>{const m=await p.getPages(),o=await m.find(e=>e.displayName==="Component_Detail_analysis").getVisuals(),y=await ye(x.user.EmployeeId);if(y&&y!=="AU02"){const e={$schema:"http://powerbi.com/product/schema#basic",target:{table:n[0].table,column:n[0].column},operator:"In",values:[x.user.Location]};let l;l=document.getElementById("dynamicGraphContainer"),p=f.get(l);try{await p.setFilters([e])}catch(h){console.log(h)}}const T=V(n[0].sessionStorageName);F.value=y=="AU02"?"":x.user.Location;const pe=F.value?[F.value]:[],q=T&&T.length>0?T:pe;let H=o.filter(e=>e.type==="slicer"&&e.title===n[0].slicerTitle)[0];if(H&&q.length>0){const e={filters:[{$schema:"http://powerbi.com/product/schema#basic",operator:"In",values:[...q],target:{table:n[0].table,column:n[0].column},filterType:d.models.FilterType.Advanced,requireSingleSelection:!0}]};try{y!=="AU02"&&(await H.setSlicerState(e),console.log("success set slicer site"))}catch(l){console.log(l)}O(n[0].slicerTitle,"In",[...q],[])}p.off("dataSelected"),p.on("dataSelected",async e=>{var h,r;let l=e.detail;if(console.log(e.detail),((h=l==null?void 0:l.visual)==null?void 0:h.title)==="component_slicer"&&setTimeout(async()=>{const t=l==null?void 0:l.dataPoints;let i=o.filter(s=>s.type==="slicer"&&s.title==="Y1")[0],g=o.filter(s=>s.type==="slicer"&&s.title==="Y2")[0],a={filters:[{$schema:"http://powerbi.com/product/schema#hierarchy",target:w,filterType:9,hierarchyData:D}]},v={filters:[{$schema:"http://powerbi.com/product/schema#hierarchy",target:S,filterType:9,hierarchyData:U}]};if((t==null?void 0:t.length)>0){let s=[],E=[],$=await o.filter(J=>J.title==="table_sample")[0].exportData();const u=z($?$.data:"");t.forEach(J=>{s=[...s,...Y(u,1)],E=[...E,...Y(u,2)]}),a={filters:[{$schema:"http://powerbi.com/product/schema#hierarchy",target:w,filterType:9,hierarchyData:s}]},v={filters:[{$schema:"http://powerbi.com/product/schema#hierarchy",target:S,filterType:9,hierarchyData:E}]}}try{await i.setSlicerState(a),console.log("slicer Y1 successfully set")}catch(s){console.error("slicer Y1 error",s)}try{await g.setSlicerState(v),console.log("slicer Y2 successfully set")}catch(s){console.error("slicer Y2 error",s)}},1500),e.detail.visual.type=="slicer"&&e.detail.visual.title!="Y1"&&e.detail.visual.title!="Y2"){let t=o.filter(i=>i.type==="slicer"&&i.title===e.detail.visual.title)[0];if(t)try{L.value=!0;const i=await t.getSlicerState();if(i){let g=[],a="",v=[];if(i.filters.length>0&&(v=[...(r=i.filters[0])==null?void 0:r.values],a=i.filters[0].operator),v.length==0||i.filters[0].operator=="NotIn"){const s=await t.exportData();s&&(g=Te(s?s.data:""))}O(e.detail.visual.title,a,v,g)}}catch(i){console.log(i)}finally{L.value=!1}}e.detail.visual.type=="slicer"&&e.detail.visual.title=="Y1"&&e.detail.visual.title=="Y2"&&console.log("hereee")}),p.off("buttonClicked"),p.on("buttonClicked",async e=>{if(e.detail.title=="Export_PDF"){le();return}if(!e.detail.title.includes("clear")&&!e.detail.title.includes("clr"))return;const l=n.findIndex(r=>{var t;return(t=r.btnClearTitles)==null?void 0:t.includes(e.detail.title)});if(l==-1)return;for(let r=l;r<n.length;r++){const t=n[r];O(t.slicerTitle,"",[],[])}if(n[0].btnClearTitles.findIndex(r=>e.detail.title.includes(r))!=-1){const r=F.value==""?[]:{filters:[{$schema:"http://powerbi.com/product/schema#basic",operator:"In",values:[F.value],target:{table:n[0].table,column:n[0].column},filterType:1,requireSingleSelection:!0}]};try{await(await m.find(a=>a.isActive).getVisuals()).filter(a=>a.type==="slicer"&&a.title===n[0].slicerTitle)[0].setSlicerState(r),console.log("success set site again"),O(n[0].slicerTitle,"In",F.value==""?[]:[],[])}catch(t){console.log(t)}}if(e.detail.title&&e.detail.title==="btn_clear_component"){let r=o.filter(a=>a.type==="slicer"&&a.title==="Y1")[0],t=o.filter(a=>a.type==="slicer"&&a.title==="Y2")[0];const i={filters:[{$schema:"http://powerbi.com/product/schema#hierarchy",target:w,filterType:9,hierarchyData:D}]},g={filters:[{$schema:"http://powerbi.com/product/schema#hierarchy",target:S,filterType:9,hierarchyData:U}]};try{await r.setSlicerState(i),console.log("slicer Y1 successfully set")}catch(a){console.error("slicer Y1 error",a)}try{await t.setSlicerState(g),console.log("slicer Y2 successfully set")}catch(a){console.error("slicer Y2 error",a)}}}),n.forEach(async e=>{let l=o.filter(r=>r.type==="slicer"&&r.title===e.slicerTitle)[0];const h=V(e.sessionStorageName);if(l)if(h&&h.length>0){const r=ne(e.table,e.column,e.schema,e.filterType,h);try{await l.setSlicerState(r),console.log("success set slicer "+e.slicerTitle),console.log(r)}catch(t){console.log(t)}if(e.slicerTitle==="component_slicer"){let t=o.filter(u=>u.type==="slicer"&&u.title==="Y1")[0],i=o.filter(u=>u.type==="slicer"&&u.title==="Y2")[0],g=[],a=[],s=await o.filter(u=>u.title==="table_sample")[0].exportData();const E=z(s?s.data:"");h.forEach(u=>{g=[...g,...Y(E,1)],a=[...a,...Y(E,2)]});const W={filters:[{$schema:"http://powerbi.com/product/schema#hierarchy",target:w,filterType:9,hierarchyData:g}]},$={filters:[{$schema:"http://powerbi.com/product/schema#hierarchy",target:S,filterType:9,hierarchyData:a}]};try{await t.setSlicerState(W),console.log("slicer Y1 successfully set")}catch(u){console.error("slicer Y1 error",u)}try{await i.setSlicerState($),console.log("slicer Y2 successfully set")}catch(u){console.error("slicer Y2 error",u)}}}else try{const t=(await l.getSlicerState()).filters[0].values;t&&t.length>0&&O(e.slicerTitle,"In",t,[])}catch(r){console.log(r)}});const me=new Date;let k=new Date;k.setMonth(k.getMonth()-5),k.setDate(1),k=new Date(k);const ue={$schema:"http://powerbi.com/product/schema#advanced",target:{table:"vw_f_pm_ehms_health_data_temp",column:"sample_date"},filterType:d.models.FilterType.Advanced,logicalOperator:"And",conditions:[{operator:"GreaterThanOrEqual",value:k.toISOString()},{operator:"LessThan",value:me.toISOString()}]};try{let r=(await(await p.getPages()).filter(function(i){return i.isActive})[0].getVisuals()).filter(function(i){return i.type==="slicer"&&i.name==="5e45efedbb747986d411"})[0];await r.setSlicerState({filters:[ue]}),console.log("Date slicer was set.");const t=await r.getSlicerState();console.log(t)}catch(e){console.log(e)}}),p.on("error",async function(m){m.detail=="TokenExpired"&&await j(async()=>{await R()}),p.off("error")})}}catch(c){console.log(c)}},le=()=>{p&&p.print()},j=async c=>{await C[he.GET_PBI_CONFIG]({reportName:b.reportName,isPublic:b.isPublic,reportId:b.pbiReportId,workspaceId:b.pbiWorkspaceId}),c()},R=async()=>{await p.setAccessToken(P.value.embedToken.token),await p.refresh()},ce=()=>{const f=be(new Date),_=Date.parse(P.value.embedToken.expiration)-f,o=Pe*60*1e3;_<=o&&j(async()=>{await R()})},O=async(c,f,m,_)=>{let o=[];m.length>0&&f=="In"?o=[...m]:m.length>0&&f=="NotIn"&&(o=_.filter(T=>T!=""&&m.indexOf(T)==-1)),console.log(o,c);const y=n.find(T=>T.slicerTitle==c);y&&sessionStorage.setItem(y.sessionStorageName,JSON.stringify(o))},V=c=>{const f=sessionStorage.getItem(c);return f?JSON.parse(f):[]},ne=(c,f,m,_,o)=>{if(m=="basic")return{filters:[{$schema:"http://powerbi.com/product/schema#${schema}",operator:"In",values:o,target:{column:f,table:c},filterType:_,requireSingleSelection:!1}]};if(m=="advanced"){const y={filters:[{$schema:"http://powerbi.com/product/schema#${schema}",logicalOperator:"And",target:{column:f,table:c},filterType:_,conditions:[]}]};return o.forEach(T=>{y.filters[0].conditions.push({operator:"Is",value:T})}),y}return{}};return ee(async()=>{await j(()=>{se(),ae.value=!1}),B.value=setInterval(()=>{ce()},ke)}),Se(()=>{B.value&&clearInterval(B.value)}),(c,f)=>{const m=De("loading");return Ie((te(),we("div",{id:"dynamicGraphContainer","element-loading-background":"#2d2b39b3",ref_key:"reportContainer",ref:N,class:"my-2",style:{height:"71.5vh"}},null,512)),[[m,ie.value||L.value]])}}}),xe=re(Ee,[["__scopeId","data-v-384d127c"]]),Ae="AM-EHM-Dynamic-Graph",Oe="a9befe6f-7bc4-4d4a-91c1-8715b01416c5",$e="d90b69f1-3a2e-423e-9e27-e341dc02a972",Ue=Z({__name:"Index",setup(G){const M=X(),w=Q(),S=I(!1),D=I(!1),Y=setInterval(()=>{D.value&&(S.value=!0,x())},1*60*1e3),x=async()=>{const C={email:w.user.Email,ver:"v1"};if(S.value){try{await de.get(fe,"",new URLSearchParams(C).toString())}catch(A){console.log(A)}S.value=!1}};return Ye(()=>{M[ge.SET_PBI_URL]("https://digital-bumaau-dev-apm-001.azure-api.net/amadm")}),ee(()=>{D.value=!0}),Ce(()=>{D.value=!1,clearInterval(Y)}),(b,C)=>(te(),Fe(xe,{reportName:Ae,visibletab:!1,isPublic:!1,isTransparent:!0,pbiReportId:Oe,pbiWorkspaceId:$e,isHideVisualHeaders:!0,class:"dashboard"}))}}),wt=re(Ue,[["__scopeId","data-v-a0d302f9"]]);export{wt as default};
