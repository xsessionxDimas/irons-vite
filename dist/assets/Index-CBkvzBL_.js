import{u as V,c as K,b as Y,G as Q}from"./index-BCnwA6yE.js";import{A as X,M as Z}from"./PbiEmbeddedEnums-BaTTPSF0.js";import{p as S}from"./powerbi-client-BGzjSA60.js";import{u as F}from"./vuex-BbOKrtVp.js";import{d as ee}from"./date-format-BASVuupi.js";import{o as te}from"./vue-router-iNp9kJ0K.js";import{g as ie,a as oe,c as ae}from"./utils-CryoXyYA.js";import{k as B,r as h,c as O,o as R,y as se,p as M,aa as re,Y as ne,a7 as le,L as ce,q as pe}from"./@vue-BypzYtbH.js";import{_ as me}from"./nw-img-vue-CR837WER.js";import"./object-path-BACu75q6.js";import"./attr-accept-BWI1aNlo.js";import"./pinia-BjOS2_Ao.js";import"./crypto-js-BZehCumu.js";import"./cron-Ci8nYs3o.js";import"./luxon-C_T8jI2d.js";import"./dexie-CWyjz2Lo.js";import"./element-plus-C5R56mia.js";import"./dayjs-C7SXsQPH.js";import"./lodash-Cr9vlq0V.js";import"./resize-observer-polyfill-B1PUzC5B.js";import"./normalize-wheel-xcxZ5rdH.js";import"./mitt-C1xD_ZTF.js";import"./@popperjs-WhmJkuoZ.js";import"./async-validator-DK9uouaC.js";import"./axios-N3crNZ6y.js";import"./vue-axios-BaogFJPH.js";import"./sweetalert2-DK0FVkv3.js";import"./@azure-DwL0pga8.js";import"./uuid-SoommWqA.js";import"./vue-inline-svg-Bgl3eqMC.js";import"./vee-validate-C_msoaAA.js";import"./@microsoft-C248spM2.js";import"./@nevware21-CKApUIxW.js";import"./moment-C5S46NFB.js";import"./urls-Cljsxeb-.js";const ue=5,de=3e5,fe=B({__name:"PbiReportSiteLevel",props:["reportName","visibletab","isPublic","pbiReportId","pbiWorkspaceId","isHideVisualHeaders","isTransparent"],emits:["handle-click"],setup(E,{emit:C}){const y=V(),c=E,b=F(),i=ae,T=h();let s;const w=h(0),m=h(""),_=h(!1),$=O(()=>b.getters.getIsDashboardConfigLoading),I=O(()=>b.getters.getDashboardConfigPbi),j=()=>{const a={type:"report",tokenType:S.models.TokenType.Embed||"",accessToken:I.value.embedToken.token||"",embedUrl:I.value.embedReport[0].embedUrl||"",id:I.value.embedReport[0].reportId||"",permissions:S.models.Permissions.All,settings:{panes:{filters:{visible:!1},pageNavigation:{visible:typeof c.visibletab>"u"?!0:c.visibletab}}}};return c.isTransparent&&(a.settings.background=S.models.BackgroundType.Transparent),a},J=()=>{try{if(typeof I.value<"u"){const a=j();let t=new S.service.Service(S.factories.hpmFactory,S.factories.wpmpFactory,S.factories.routerFactory);T.value&&(s=t.embed(T.value,a)),s.off("loaded"),s.on("loaded",async()=>{const o=await s.getPages(),d=await o.find(e=>e.displayName==="Site Level").getVisuals();s.off("dataSelected"),s.on("dataSelected",async e=>{if(console.log(e),e.detail.visual.type=="slicer")try{_.value=!0;let r=(await(await s.getActivePage()).getVisuals()).filter(l=>l.type==="slicer"&&l.title===e.detail.visual.title)[0];const n=await r.getSlicerState();if(n){let l=[],u="",g=[];if(n.filters.length>0&&(g=[...n.filters[0].values],u=n.filters[0].operator),g.length==0||n.filters[0].operator=="NotIn"){let q=await r.exportData();l=ie(q?q.data:"")}k(e.detail.visual.title,u,g,l)}}catch(p){console.log(p)}finally{_.value=!1}e.detail.visual.title=="Table_Detail"&&G(e.detail.dataPoints[0].identity)}),s.off("buttonClicked"),s.on("buttonClicked",async e=>{if(!e.detail.title.includes("clear")&&!e.detail.title.includes("clr"))return;const p=i.findIndex(r=>r.btnClearTitles.includes(e.detail.title));if(p==-1)return;for(let r=p;r<i.length;r++){const n=i[r];k(n.slicerTitle,"",[],[])}if(i[0].btnClearTitles.findIndex(r=>e.detail.title.includes(r))!=-1){const r=m.value==""?[]:{filters:[{$schema:"http://powerbi.com/product/schema#basic",operator:"In",values:[m.value],target:{table:i[0].table,column:i[0].column},filterType:1,requireSingleSelection:!0}]};try{await(await o.find(g=>g.isActive).getVisuals()).filter(g=>g.type==="slicer"&&g.title===i[0].slicerTitle)[0].setSlicerState(r),console.log("success set site again"),k(i[0].slicerTitle,"In",m.value==""?[]:[],[])}catch(n){console.log(n)}}});const v=await oe(y.user.EmployeeId);if(v&&v!=="AU02"){const e={$schema:"http://powerbi.com/product/schema#basic",target:{table:i[0].table,column:i[0].column},operator:"In",values:[y.user.Location]};let p;p=document.getElementById("siteLevelContainer"),s=t.get(p);try{await s.setFilters([e])}catch(N){console.log(N)}}const f=D(i[0].sessionStorageName);m.value=v=="AU02"?"":y.user.Location;const z=m.value?[m.value]:[],A=f&&f.length>0?f:z;let x=d.filter(e=>e.type==="slicer"&&e.title===i[0].slicerTitle)[0];if(x&&A.length>0){const e={filters:[{$schema:"http://powerbi.com/product/schema#basic",operator:"In",values:[...A],target:{table:i[0].table,column:i[0].column},filterType:1,requireSingleSelection:!0}]};try{v!=="AU02"&&(await x.setSlicerState(e),console.log("success set slicer site"))}catch(p){console.log(p)}k(i[0].slicerTitle,"In",[...A],[])}i.forEach(async e=>{let r=(await(await s.getActivePage()).getVisuals()).filter(l=>l.type==="slicer"&&l.title===e.slicerTitle)[0];const n=D(e.sessionStorageName);if(r)if(n&&n.length>0){const l={filters:[{$schema:"http://powerbi.com/product/schema#basic",operator:"In",values:n,target:{column:e.column,table:e.table},filterType:1,requireSingleSelection:!1}]};try{await r.setSlicerState(l)}catch(u){console.log(u)}}else try{const u=(await r.getSlicerState()).filters[0].values;u&&u.length>0&&k(e.slicerTitle,"In",u,[])}catch(l){console.log(l)}})}),s.on("error",async function(o){o.detail=="TokenExpired"&&await U(()=>{L()}),s.off("error")})}}catch(a){console.log(a)}},U=async a=>{await b.dispatch(X.GET_PBI_CONFIG,{reportName:c.reportName,isPublic:c.isPublic,reportId:c.pbiReportId,workspaceId:c.pbiWorkspaceId}),a()},D=a=>{const t=sessionStorage.getItem(a);return t?JSON.parse(t):[]},L=async()=>{await s.setAccessToken(I.value.embedToken.token),await s.refresh()},H=()=>{const t=ee(new Date),P=Date.parse(I.value.embedToken.expiration)-t,d=ue*60*1e3;P<=d&&U(function(){L()})},k=async(a,t,o,P)=>{let d=[];o.length>0&&t=="In"?d=[...o]:o.length>0&&t=="NotIn"&&(d=P.filter(f=>f!=""&&o.indexOf(f)==-1)),console.log(d);const v=i.find(f=>f.slicerTitle==a);v&&sessionStorage.setItem(v.sessionStorageName,JSON.stringify(d))},G=a=>{let t={siteDescription:"",componentName:"",modelUnit:"",equipment:""};a.forEach(o=>{o.target.column=="site_description"?t.siteDescription=o.equals:o.target.column=="component_name"?t.componentName=o.equals:o.target.column=="model_unit"?t.modelUnit=o.equals:o.target.column=="equipment"&&(t.equipment=o.equals)}),t.siteDescription!=""&&t.componentName!=""&&t.modelUnit!=""&&t.equipment!=""?(sessionStorage.setItem(i[0].sessionStorageName,JSON.stringify([t.siteDescription])),sessionStorage.setItem(i[4].sessionStorageName,JSON.stringify([t.componentName])),sessionStorage.setItem(i[2].sessionStorageName,JSON.stringify([t.modelUnit])),sessionStorage.setItem("IronPortalDashboardFilter-Equipment",JSON.stringify([t.equipment])),W()):console.log("There are some unprovided data")},W=()=>{const a=window.open("#/ironportal-dashboard/equipment","_blank");(!a||a.closed||typeof a.closed>"u")&&K("Please allow pop-up permission on your browser if equipment page is not opened in a new tab.","OK")};return R(async()=>{await U(()=>{J()}),w.value=setInterval(()=>{H()},de)}),te(async()=>{w.value&&clearInterval(w.value)}),(a,t)=>{const o=ne("loading");return se((M(),re("div",{id:"siteLevelContainer","element-loading-background":"#2d2b39b3",ref_key:"reportContainer",ref:T,class:"my-5",style:{height:"90vh"}},null,512)),[[o,$.value||_.value]])}}}),ge="AM-EHM-Site-Level",be="a9befe6f-7bc4-4d4a-91c1-8715b01416c5",ve="d90b69f1-3a2e-423e-9e27-e341dc02a972",Se=B({__name:"Index",setup(E){const C=F(),y=V(),c=h(!1),b=h(!1),T=setInterval(()=>{b.value&&(c.value=!0,s())},1*60*1e3),s=async()=>{const m={email:y.user.Email,ver:"v1"};if(c.value){try{await Y.get(Q,"",new URLSearchParams(m).toString())}catch(_){console.log(_)}c.value=!1}};return le(()=>{C.commit(Z.SET_PBI_URL,"https://digital-bumaau-dev-apm-001.azure-api.net/amadm")}),R(()=>{b.value=!0}),ce(()=>{b.value=!1,clearInterval(T)}),(w,m)=>(M(),pe(fe,{reportName:ge,pbiReportId:be,pbiWorkspaceId:ve,visibletab:!1,isPublic:!1,isTransparent:!0,isHideVisualHeaders:!0,class:"site-level-dashboard"}))}}),et=me(Se,[["__scopeId","data-v-3d0040c9"]]);export{et as default};
