import{u as $,A as W}from"./usePbiEmbeddedStore-Bda_75jS.js";import{p as b}from"./powerbi-client-99lwt5rM.js";import{k as G}from"./date-format-8-IvfSl3.js";import{o as H}from"./vue-router-iNp9kJ0K.js";import{a as K,k as M}from"./index-BuVmIl8K.js";import{g as Y,a as z,c as Q}from"./utils-BpQp1sv3.js";import{k as X,r as T,c as O,o as Z,y as ee,p as te,aa as ie,Y as ae}from"./@vue-BypzYtbH.js";const oe=5,se=3e5,fe=X({__name:"PbiReport",props:["reportName","visibletab","idPageName","isPublic","pbiReportId","pbiWorkspaceId","isHideVisualHeaders","isTransparent"],emits:["handle-click"],setup(V,{emit:re}){const w=K(),f=V,k=$(),a=Q,P=T();let s;const N=T(0),v=T(""),C=T(!1),x=O(()=>k.getIsDashboardConfigLoading),S=O(()=>k.getDashboardConfigPbi),L=()=>{const o={type:"report",tokenType:b.models.TokenType.Embed||"",accessToken:S.value.embedToken.token||"",embedUrl:S.value.embedReport[0].embedUrl||"",id:S.value.embedReport[0].reportId||"",permissions:b.models.Permissions.All,settings:{panes:{filters:{visible:!1},pageNavigation:{visible:typeof f.visibletab>"u"?!0:f.visibletab}}}};return f.isTransparent&&(o.settings.background=b.models.BackgroundType.Transparent),o},F=()=>{try{if(typeof S.value<"u"){const o=L();let t=new b.service.Service(b.factories.hpmFactory,b.factories.wpmpFactory,b.factories.routerFactory);P.value&&(s=t.embed(P.value,o)),s.off("loaded"),s.on("loaded",async()=>{const i=await s.getPages(),p=await i.find(e=>e.displayName==="Buma Level").getVisuals();s.off("dataSelected"),s.on("dataSelected",async e=>{if(e.detail.visual.type=="slicer")try{C.value=!0;let r=(await(await s.getActivePage()).getVisuals()).filter(l=>l.type==="slicer"&&l.title===e.detail.visual.title)[0];const n=await r.getSlicerState();if(n){let l=[],u="",d=[];if(n.filters.length>0&&(d=[...n.filters[0].values],u=n.filters[0].operator),d.length==0||n.filters[0].operator=="NotIn"){let E=await r.exportData();l=Y(E?E.data:"")}y(e.detail.visual.title,u,d,l)}}catch(c){console.log(c)}finally{C.value=!1}e.detail.visual.title=="Table_Detail"&&j(e.detail.dataPoints[0].identity)}),s.off("buttonClicked"),s.on("buttonClicked",async e=>{if(!e.detail.title.includes("clear")&&!e.detail.title.includes("clr"))return;const c=a.findIndex(r=>r.btnClearTitles.includes(e.detail.title));if(c==-1)return;for(let r=c;r<a.length;r++){const n=a[r];y(n.slicerTitle,"",[],[])}if(a[0].btnClearTitles.findIndex(r=>e.detail.title.includes(r))!=-1){const r=v.value==""?[]:{filters:[{$schema:"http://powerbi.com/product/schema#basic",operator:"In",values:[v.value],target:{table:a[0].table,column:a[0].column},filterType:1,requireSingleSelection:!0}]};try{await(await i.find(d=>d.isActive).getVisuals()).filter(d=>d.type==="slicer"&&d.title===a[0].slicerTitle)[0].setSlicerState(r),console.log("success set site again"),y(a[0].slicerTitle,"In",v.value==""?[]:[],[])}catch(n){console.log(n)}}});const g=await z(w.user.EmployeeId);if(g&&g!="AU02"){const e={$schema:"http://powerbi.com/product/schema#basic",target:{table:a[0].table,column:a[0].column},operator:"In",values:[w.user.Location]};let c;c=document.getElementById("bumaLevelContainer"),s=t.get(c);try{await s.setFilters([e])}catch(I){console.log(I)}}const m=_(a[0].sessionStorageName);v.value=g=="AU02"?"":w.user.Location;const R=v.value?[v.value]:[],D=m&&m.length>0?m:R;let U=p.filter(e=>e.type==="slicer"&&e.title===a[0].slicerTitle)[0];if(U&&D.length>0){const e={filters:[{$schema:"http://powerbi.com/product/schema#basic",operator:"In",values:[...D],target:{table:a[0].table,column:a[0].column},filterType:1,requireSingleSelection:!0}]};try{g!=="AU02"&&(await U.setSlicerState(e),console.log("success set slicer site"))}catch(c){console.log(c)}y(a[0].slicerTitle,"In",[...D],[])}a.forEach(async e=>{let r=(await(await s.getActivePage()).getVisuals()).filter(l=>l.type==="slicer"&&l.title===e.slicerTitle)[0];const n=_(e.sessionStorageName);if(r)if(n&&n.length>0){const l={filters:[{$schema:"http://powerbi.com/product/schema#basic",operator:"In",values:n,target:{column:e.column,table:e.table},filterType:1,requireSingleSelection:!1}]};try{await r.setSlicerState(l)}catch(u){console.log(u)}}else try{const u=(await r.getSlicerState()).filters[0].values;u&&u.length>0&&y(e.slicerTitle,"In",u,[])}catch(l){console.log(l)}})}),s.on("error",async function(i){i.detail=="TokenExpired"&&await A(()=>{q()}),s.off("error")})}}catch(o){console.log(o)}},A=async o=>{await k[W.GET_PBI_CONFIG]({reportName:f.reportName,isPublic:f.isPublic,reportId:f.pbiReportId,workspaceId:f.pbiWorkspaceId}),o()},_=o=>{const t=sessionStorage.getItem(o);return t?JSON.parse(t):[]},q=async()=>{await s.setAccessToken(S.value.embedToken.token),await s.refresh()},B=()=>{const t=G(new Date),h=Date.parse(S.value.embedToken.expiration)-t,p=oe*60*1e3;h<=p&&A(function(){q()})},y=async(o,t,i,h)=>{let p=[];i.length>0&&t=="In"?p=[...i]:i.length>0&&t=="NotIn"&&(p=h.filter(m=>m!=""&&i.indexOf(m)==-1)),console.log(p);const g=a.find(m=>m.slicerTitle==o);g&&sessionStorage.setItem(g.sessionStorageName,JSON.stringify(p))},j=o=>{let t={siteDescription:"",componentName:"",modelUnit:"",equipment:""};o.forEach(i=>{i.target.column=="site_description"?t.siteDescription=i.equals:i.target.column=="component_name"?t.componentName=i.equals:i.target.column=="model_unit"?t.modelUnit=i.equals:i.target.column=="equipment"&&(t.equipment=i.equals)}),t.siteDescription!=""&&t.componentName!=""&&t.modelUnit!=""&&t.equipment!=""&&(sessionStorage.setItem(a[0].sessionStorageName,JSON.stringify([t.siteDescription])),sessionStorage.setItem(a[4].sessionStorageName,JSON.stringify([t.componentName])),sessionStorage.setItem(a[2].sessionStorageName,JSON.stringify([t.modelUnit])),sessionStorage.setItem("IronPortalDashboardFilter-Equipment",JSON.stringify([t.equipment])),J())},J=()=>{const o=window.open("#/ironportal-dashboard/equipment","_blank");(!o||o.closed||typeof o.closed>"u")&&M("Please allow pop-up permission on your browser if equipment page is not opened in a new tab.","OK")};return Z(async()=>{await A(()=>{F()}),N.value=setInterval(()=>{B()},se)}),H(async()=>{N.value&&clearInterval(N.value)}),(o,t)=>{const i=ae("loading");return ee((te(),ie("div",{id:"bumaLevelContainer","element-loading-background":"#2d2b39b3",ref_key:"reportContainer",ref:P,class:"my-5",style:{height:"90vh"}},null,512)),[[i,x.value||C.value]])}}});export{fe as _};
