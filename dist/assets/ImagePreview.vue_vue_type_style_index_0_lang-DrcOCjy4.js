import{f as H,c as Y}from"./index-BuVmIl8K.js";import{_ as J}from"./Confirmation.vue_vue_type_style_index_0_lang-HchphDdZ.js";import{e as K}from"./lodash-DrHMlsdo.js";import{_ as Q}from"./FullScreenDialog.vue_vue_type_style_index_0_lang-DXRDt27h.js";import{s as j}from"./string-to-imageinfo-converter-Cdr1iOkP.js";import{k as W,r as c,a0 as X,c as Z,d as ee,p,aa as b,s as y,x as C,F as q,R as _,aB as L,$ as te,A as I,q as ae}from"./@vue-BypzYtbH.js";const oe={class:"row my-4"},le={class:"bg-secondary"},ne=["src","onClick"],se={key:0,class:"row mt-7 mb-0"},ie=L("h5",{style:{"font-size":"15px","font-weight":"900"},class:"font-weight-bold text-dark"},"Mandatory to keep at least one photo as an evidence.",-1),re=[ie],pe=W({__name:"ImagePreview",props:{visibility:{type:Boolean,required:!1},index:{required:!1,type:Number,default:-1},images:{type:Array,required:!0},showDeleteButton:{type:Boolean,required:!0,default:!0},type:{type:String,required:!0},reRender:{type:Boolean,default:!1},showMandatoryCaption:{type:Boolean,default:!1},isMonitoring:{type:Boolean,default:!1},isMandatory:{required:!1,type:Boolean,default:!0},oldVersion:{required:!1,type:Boolean,default:!0}},emits:["onClose","onDelete","onDownloaded"],setup(x,{emit:A}){const l=x,w=A,d=c([]),k=X(l,"visibility"),h=c(!1),m=c(""),D=c(0),g=c([]),f=c([]),i=c([]),B=c(""),R=c(!1),M=Z(()=>{let e=!1;return l.showDeleteButton&&(e=!0),l.isMonitoring&&(e=!1),e}),V=e=>{var n;if(d.value.length<1)return;let t;do t=(n=d.value.find(o=>o.key==e))==null?void 0:n.value;while(!t);return t},N=()=>{k.value=!1,w("onClose",null)};ee(()=>l.reRender,async()=>{await U()});const U=async()=>{if(S(),D.value=0,d.value=[],!l.images)return;f.value=j(l.images),g.value=Array.apply(null,Array(l.images.length)).map(function(){return!0});const e=f.value.length;for(let t=D.value;t<e;t++){const n=f.value[t].filename,o=await H.pendingTaskFile.where({filename:n}).first();try{if(!o)await $(n,t);else{const s=K.cloneDeep(o);let r=window.URL||window.webkitURL;d.value.push({key:n,value:r.createObjectURL(s.blob)}),g.value[t]=!1,i.value.forEach(a=>{a.imgBlob==n&&(a.url=r.createObjectURL(s.blob))})}}catch(s){console.log(s)}}},S=()=>{const e=j(l.images);i.value=e==null?void 0:e.map(t=>({imgBlob:t.filename,url:"",description:t.description}))},$=async(e,t)=>{const n={fileUrl:e,ver:"v1"};try{const o=`https://digital-bumaau-dev-apm-001.azure-api.net/dinspect/api/attachment/download_by_url?${new URLSearchParams(n).toString()}`,s=await Y.getBlob(o);if(l.isMonitoring){const r=new Blob([s.data]);let a=window.URL||window.webkitURL;d.value.push({key:e,value:a.createObjectURL(r)}),i.value.forEach(u=>{u.imgBlob==e&&(u.url=a.createObjectURL(r))}),g.value[t]=!1}else{const r=s.data,a=new Blob([r]),u={};u.filename=e,u.blob=a,u.type=l.type;const v={};v.image=u,v.index=t,v.length=l.images.length,w("onDownloaded",v),window.setTimeout(async()=>{let O=window.URL||window.webkitURL;d.value.push({key:e,value:O.createObjectURL(a)}),i.value.forEach(F=>{F.imgBlob==e&&(F.url=O.createObjectURL(a))}),g.value[t]=!1},1e3)}}catch(o){console.log("image",o)}},E=e=>{const t=i.value.findIndex(o=>o.imgBlob==e),n=i.value[t];if(t>0){const o=i.value.slice(t),s=i.value.slice(0,t);i.value=[...o,...s]}B.value=n.url,R.value=!0},T=()=>{B.value="",R.value=!1},P=e=>{h.value=!0,m.value=e},z=()=>{h.value=!1},G=()=>{h.value=!1,d.value=d.value.filter(e=>e.key!=m.value),f.value=f.value.filter(e=>e.filename!=m.value),l.index>=0?w("onDelete",{index:l.index,filename:m.value}):w("onDelete",m.value),m.value=""};return(e,t)=>{const n=_("el-skeleton-item"),o=_("NwImg"),s=_("el-skeleton"),r=_("el-dialog");return p(),b(q,null,[y(r,{modelValue:k.value,"onUpdate:modelValue":t[0]||(t[0]=a=>k.value=a),title:"Detailed picture",width:"80%",onOpened:U,onOpen:U,onClose:N},{default:C(()=>[L("div",oe,[(p(!0),b(q,null,te(f.value,(a,u)=>(p(),b("div",{key:a.filename,class:"col-md-3 fv-row fv-plugins-icon-container p-2 rounded position-relative"},[y(s,{loading:g.value[u],animated:""},{template:C(()=>[y(n,{variant:"image",class:"w-100 rounded",style:{height:"200px","object-fit":"fill"}})]),default:C(()=>[L("div",le,[V(a.filename)!=null?(p(),b("img",{key:0,src:V(a.filename),class:"w-100 rounded",style:{height:"200px","object-fit":"contain",cursor:"pointer"},alt:"images",onClick:v=>E(a.filename)},null,8,ne)):I("",!0),M.value?(p(),ae(o,{key:1,onClick:v=>P(a.filename),class:"delete-image-button",src:"/media/svg/dma/image-close-button-red.png"},null,8,["onClick"])):I("",!0)])]),_:2},1032,["loading"])]))),128))]),x.showMandatoryCaption?(p(),b("div",se,re)):I("",!0)]),_:1},8,["modelValue"]),y(J,{visibility:h.value,caption:"Are you sure want to delete this image?",onOnNoConfirm:z,onOnYesConfirm:G},null,8,["visibility"]),y(Q,{images:i.value,visibility:R.value,image:B.value,onHandleClose:T},null,8,["images","visibility","image"])],64)}}});export{pe as _};
